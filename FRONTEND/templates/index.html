<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech to Phoneme Converter</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto max-w-md">
        <div class="bg-white shadow-2xl rounded-2xl p-8 border-2 border-blue-100">
            <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-6">
                Speech to Phoneme Converter
            </h1>

            <!-- LSTM Model Upload Section -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                <h2 class="text-xl font-bold text-gray-700 mb-2">LSTM Model</h2>
                <div class="flex flex-col">
                    <label class="block text-gray-700 font-bold mb-2" for="modelFileInput">
                        Upload LSTM Model (.h5 file)
                    </label>
                    <input 
                        type="file" 
                        id="modelFileInput" 
                        accept=".h5"
                        class="flex-grow px-4 py-2 border-2 border-yellow-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition duration-300"
                    >
                    <button 
                        id="uploadModel" 
                        class="w-full mt-4 bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition duration-300 flex items-center justify-center"
                    >
                        Upload LSTM Model
                    </button>
                    <p id="modelStatus" class="text-gray-600 mt-2 text-sm">
                        No model uploaded yet. Default wav2vec will be used.
                    </p>
                </div>
            </div>

            <!-- WAV File Conversion Section -->
            <div class="mb-6">
                <label class="block text-gray-700 font-bold mb-2" for="wavFileInput">
                    Upload WAV File
                </label>
                <div class="flex">
                    <input 
                        type="file" 
                        id="wavFileInput" 
                        accept=".wav"
                        class="flex-grow px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300"
                    >
                </div>
                
                <!-- Model Selection -->
                <div class="mt-4 flex items-center">
                    <span class="mr-2 text-gray-700 font-bold">Processing Method:</span>
                    <div class="flex space-x-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="modelChoice" value="wav2vec" checked class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Wav2Vec</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="modelChoice" value="lstm" class="form-radio text-yellow-600">
                            <span class="ml-2 text-gray-700">LSTM Model</span>
                        </label>
                    </div>
                </div>
                
                <button 
                    id="convertWav" 
                    class="w-full mt-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300 flex items-center justify-center"
                >
                    Convert WAV to Phonemes
                </button>
            </div>

            <!-- Results Section -->
            <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 min-h-[120px]">
                <h2 class="font-bold text-gray-700 mb-2">Results:</h2>
                <div id="resultsContent" class="space-y-2">
                    <p id="originalText" class="text-gray-600 italic">
                        Converted speech will appear here...
                    </p>
                    <p id="phonemesResult" class="text-blue-700 font-mono break-words">
                        Arpabet phoneme representation will be displayed here...
                    </p>
                    <p id="ipaResult" class="text-green-700 font-mono break-words">
                        IPA representation will be displayed here...
                    </p>
                </div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="text-center text-gray-500 mt-4 text-sm">
            Made By: Pranjal Deuri, Sweth Pandey, Abishek Kr Singh, Manoj Charla
        </div>
    </div>

    <script>
        // Model upload status
        let modelUploaded = false;

        function showError(message, details = '') {
            const originalText = document.getElementById('originalText');
            const phonemesResult = document.getElementById('phonemesResult');
            const ipaResult = document.getElementById('ipaResult');
            
            originalText.textContent = 'Error';
            phonemesResult.textContent = message;
            ipaResult.textContent = details || message;
            console.error('Conversion Error:', message, details);
        }

        // Model Upload Handler
        document.getElementById('uploadModel').addEventListener('click', async () => {
            const modelFileInput = document.getElementById('modelFileInput');
            const modelStatus = document.getElementById('modelStatus');
            
            // Reset status
            modelStatus.textContent = 'Uploading model...';
            modelStatus.className = 'text-gray-600 mt-2 text-sm';
            
            // Check if a file is selected
            if (modelFileInput.files.length === 0) {
                modelStatus.textContent = 'Please select an H5 model file';
                modelStatus.className = 'text-red-600 mt-2 text-sm';
                return;
            }

            const modelFile = modelFileInput.files[0];
            
            // Validate file type
            if (!modelFile.name.toLowerCase().endsWith('.h5')) {
                modelStatus.textContent = 'Invalid file type. Please select an H5 file';
                modelStatus.className = 'text-red-600 mt-2 text-sm';
                return;
            }

            const formData = new FormData();
            formData.append('model', modelFile);

            try {
                const response = await axios.post('/upload-model', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                    timeout: 30000  // 30-second timeout for large model files
                });

                modelUploaded = true;
                modelStatus.textContent = 'LSTM model successfully loaded!';
                modelStatus.className = 'text-green-600 mt-2 text-sm font-bold';
                
                // Auto-select LSTM radio button
                document.querySelector('input[name="modelChoice"][value="lstm"]').checked = true;
                
            } catch (error) {
                const errorMessage = error.response?.data?.error || 'Model upload failed';
                const errorDetails = error.response?.data?.details || error.message;
                
                modelStatus.textContent = `Error: ${errorMessage}`;
                modelStatus.className = 'text-red-600 mt-2 text-sm';
                console.error('Model upload error:', error.response?.data || error);
            }
        });

        // WAV File Conversion
        document.getElementById('convertWav').addEventListener('click', async () => {
            const wavFileInput = document.getElementById('wavFileInput');
            const originalText = document.getElementById('originalText');
            const phonemesResult = document.getElementById('phonemesResult');
            const ipaResult = document.getElementById('ipaResult');
            const modelChoice = document.querySelector('input[name="modelChoice"]:checked').value;

            // Check if trying to use LSTM without uploading a model
            if (modelChoice === 'lstm' && !modelUploaded) {
                showError('LSTM model not available', 'Please upload an LSTM model first');
                return;
            }

            // Reset results
            originalText.textContent = 'Converting...';
            phonemesResult.textContent = 'Processing audio...';
            ipaResult.textContent = 'Please wait...';

            // Check if a file is selected
            if (wavFileInput.files.length === 0) {
                showError('Please select a WAV file');
                return;
            }

            const wavFile = wavFileInput.files[0];

            // Validate file type
            if (wavFile.type !== 'audio/wav' && !wavFile.name.toLowerCase().endsWith('.wav')) {
                showError('Invalid file type', 'Please select a WAV audio file');
                return;
            }

            const formData = new FormData();
            formData.append('audio', wavFile);
            formData.append('model_choice', modelChoice);

            try {
                const response = await axios.post('/speech-to-text', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                    timeout: 20000  // 20-second timeout
                });

                originalText.textContent = `Speech: ${response.data.original_text}`;
                
                // Handle different formats of phonemes based on model
                if (Array.isArray(response.data.phonemes)) {
                    phonemesResult.textContent = `Arpabet Phonemes: ${response.data.phonemes.join(' ')}`;
                } else {
                    phonemesResult.textContent = `Arpabet Phonemes: ${response.data.phonemes}`;
                }
                
                ipaResult.textContent = `IPA: ${response.data.ipa}`;
                
                // Add method used
                originalText.textContent += ` (Using ${response.data.recognition_method})`;
                
            } catch (error) {
                const errorMessage = error.response?.data?.error || 'WAV to phoneme conversion failed';
                const errorDetails = error.response?.data?.details || error.message;
                
                showError(errorMessage, errorDetails);
                console.error('Full error:', error.response?.data || error);
            }
        });
    </script>
</body>
</html>